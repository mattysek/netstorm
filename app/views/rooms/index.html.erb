<script>
PrivatePub.subscribe("<%= "/channels/" + params[:channel_name] %>", function(message) {
switch(message.action)
{
	case "chat":
		$("#chat").append("<div>" + message.content + "</div>");
		$("#new_message")[0].reset();
		break;
	case "drawIdea":
		drawIdea(message.content);
		break;
}
});

window.onload = function() 
{
    stage = new Kinetic.Stage({
      container: 'canvas_container',
      width: 980,
      height: 2000
    });
    ideaColumn = 1;
    ideaRow = 1;
    ideaRotate = 0;
    drawingLayer = new Kinetic.Layer();
    stage.add(drawingLayer);
	
	<% @drawImage_messages.each do |m| %>
	drawIdea("<%= m.content %>");
	<% end %>
};
  
function drawIdea(text)
{
    if(ideaRow == 11) return;
    var text = new Kinetic.Text({
        x: 50 + (250 * (ideaColumn-1)) + Math.floor(Math.random() * (45 +45 + 1) -45),
        y: 50 + (200 * (ideaRow - 1)) + Math.floor(Math.random() * (24 +24 + 1) -24),
        stroke: '#000',
        draggable: true,
        strokeWidth: 1,
        fill: '#ffc',
        text: text,
        fontSize: 13,
        fontFamily: 'Tahoma',
        textFill: '#000',
        width: 200,
        padding: 10,
        align: 'justify',
        fontStyle: 'italic',
        shadow: {
        color: 'black',
        blur: 4,
        offset: [5, 5],
        opacity: 0.3
        }
    });
    var rotate = -1;
    if(ideaRotate % 3 == 0 || ideaRotate % 5 == 0) rotate = 1;
    text.rotate((Math.PI/60)*rotate);
    ideaColumn++;
    if(ideaColumn == 5)
    {
        ideaColumn = 1;
        ideaRow++;
    }
    ideaRotate++;
    
    drawingLayer.add(text);
    drawingLayer.draw();
}

function toImage() 
{
    stage.toDataURL({
        callback: function(dataUrl) {
            window.open(dataUrl);
        }
    });
}

function toJSON() 
{
	stage.toJSON();
}
</script>
<%= subscribe_to "/channels/" + params[:channel_name] %>
<div id="templatemo_body_wrapper">
	<div id="templatemo_wrapper">
        <div id="templatemo_header">
            <div id="site_title"><h1><%= link_to "Brainstorming online", "/"%></h1></div>
            <div id="templatemo_menu">
                <ul>
				  <% if not current_user %>
					  <li><a href="/" class="current">Home</a></li>
					  <li><a href="about.html">About</a></li>
					  <li><a href="contact.html" class="last">Contact</a></li>
				  <% else %>
					  <li><a href="/" class="current">Home</a></li>
					  <li><a href="about.html">About</a></li>
					  <li><a href="contact.html">Contact</a></li>
					  <li><a href="/logout" class="last">Log out</a></li>
				  <% end %>
                </ul>
            </div>
        </div>
        <div id="templatemo_middle">
            <div id="mid_left">
			    <% if current_user %>
					<div id="mid_title">Welcome <%= current_user.name %> </div>
					<p><%= current_user.email %></p>
				<% else %>
					<div id="mid_title">Brainstorming online</div>
					<p>Netstorming is service allowing you to work on topics with your colleagues online using brainstorming technique.</p>
					<p>Try it right now, log in using your facebook or google account right now!</p>
					<p class="top_p_last">LOG IN WITH:</p>
						<a href="/auth/facebook" class="facebook"></a>
						<a href="/auth/google_oauth2" class="google"></a>
				<% end %>
            </div>
			<%=image_tag("ntstr.png", alt: "NetStorming", width: "270px", height: "270px")%>
        </div>
        <div id="templatemo_main">
        	<div class="cbox_fw">
                <div class="cbox_3b fp_box"><span class="b1"></span>
                    <h4><a href="#">New Interaction</a></h4>
                    <p>Home office? We are perfect for you!</p>
                </div>
                <div class="cbox_3b fp_box"><span class="b2"></span>
                    <h4><a href="#">New ideas</a></h4>
                    <p>Have all your ideas in one place.</p>
                </div>
                <div class="cbox_3b cbox_rm fp_box"><span class="b3"></span>
                    <h4><a href="#">Economic style</a></h4>
                    <p>Obviously...</p>
                </div>
                <div class="cleaner"></div>
            </div>
            <div class="cbox_fw">
            		<div id="canvas_container"></div>
					<div id="canvas_buttons">
					<!--
					  <textarea id="textinput" rows="4" cols="50">
					  </textarea>
					  <!--<input type="button" value="Draw Idea" onclick="drawIdea(document.getElementById('textinput').value)"/>
					  <input type="button" value="Export to JSON" onclick="toJSON()"/>
					  <input type="button" value="Export to image" onclick="toImage()"/>-->
					  <%= form_for Message.new, :url => "/chatrooms/" + params[:channel_name] + "/create_message", remote: true do |f| %>
						<%= f.hidden_field :action, :value => "drawIdea" %>
						<%= f.text_field :content %>
						<%= f.submit "Send" %>
					  <% end %>
					</div>
                <div class="cbox_small float_r">
                	<div id="chat">
					  <%= render @chat_messages, :template => 'rooms/message' %>
					</div>
					<%= form_for Message.new, :url => "/chatrooms/" + params[:channel_name] + "/create_message", remote: true do |f| %>
					  <%= f.hidden_field :action, :value => "chat" %>
					  <%= f.text_field :content %>
					  <%= f.submit "Send" %>
					<% end %>
                </div>
                <div class="cleaner"></div>
            </div>
        </div>
    </div>
</div>
<div id="templatemo_footer_wrapper">
    <div id="templatemo_footer">
        Copyright 2013 <a href="/">NetStorming</a>
        <div class="cleaner"></div>
    </div>
</div>